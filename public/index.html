<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>We-Reader</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 使用 Inter 字体 */
        body {
            font-family: 'Inter', 'Noto Sans SC', sans-serif;
        }
        /* 简单的加载动画 */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div class="w-full max-w-3xl bg-white rounded-lg shadow-lg p-6 md:p-8">
        <h1 class="text-4xl md:text-5xl font-bold text-center text-gray-800 mb-3">
            We-Reader
        </h1>
        <p class="text-center text-gray-600 text-sm mb-8">
            任何网页变成 Markdown，想咋修改都得当
        </p>

        <!-- 输入区域 -->
        <div class="mb-6">
            <div class="flex flex-col sm:flex-row gap-2">
                <input
                    type="text"
                    id="urlInput"
                    placeholder="粘贴文章链接 (微信公众号、三联生活周刊等)"
                    class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
                <button
                    id="convertButton"
                    class="flex-shrink-0 bg-blue-600 text-white font-semibold py-3 px-8 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200 flex items-center justify-center"
                >
                    <span id="buttonText">转换</span>
                    <div id="buttonLoader" class="loader hidden"></div>
                </button>
            </div>
        </div>

        <!-- 底部小字 -->
        <div class="text-center text-gray-500 text-xs space-y-2 mb-6">
            <p>支持微信公众号及任意网页链接。</p>
            <p>一键卸妆，只留干货。你的知识库，就该这么清爽！</p>
        </div>

        <!-- 提示信息 -->
        <div id="messageBox" class="text-center p-3 rounded-lg mb-4 hidden"></div>
        
        <!-- 单个结果区域 -->
        <div class="mt-6" id="resultArea" style="display: none;">
            <div class="flex justify-between items-center mb-2">
                <h2 class="text-xl font-semibold text-gray-700">转换结果</h2>
                <div class="flex gap-2">
                    <button id="copyButton" class="text-sm bg-gray-200 text-gray-700 py-1 px-3 rounded-lg hover:bg-gray-300 transition">复制</button>
                    <button id="downloadButton" class="text-sm bg-green-600 text-white py-1 px-3 rounded-lg hover:bg-green-700 transition">下载 .md 文件</button>
                </div>
            </div>
            <textarea
                id="markdownOutput"
                rows="15"
                class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50 font-mono text-sm"
                readonly
            ></textarea>
            <p class="text-xs text-gray-500 mt-2">
                <strong>注意:</strong> 微信图片 (mmbiz.qpic.cn) 受防盗链保护，可能无法在 VSCode 等 Markdown 预览中显示。
            </p>
        </div>

    </div>

    <script>
        // DOM 元素
        const urlInput = document.getElementById('urlInput');
        const convertButton = document.getElementById('convertButton');
        const buttonText = document.getElementById('buttonText');
        const buttonLoader = document.getElementById('buttonLoader');
        
        const messageBox = document.getElementById('messageBox');
        const resultArea = document.getElementById('resultArea');
        const markdownOutput = document.getElementById('markdownOutput');
        const copyButton = document.getElementById('copyButton');
        const downloadButton = document.getElementById('downloadButton');

        let articleTitle = 'article';

        // 设置按钮为加载状态
        function setLoading(isLoading) {
            if (isLoading) {
                buttonText.classList.add('hidden');
                buttonLoader.classList.remove('hidden');
                convertButton.disabled = true;
                urlInput.disabled = true;
            } else {
                buttonText.classList.remove('hidden');
                buttonLoader.classList.add('hidden');
                convertButton.disabled = false;
                urlInput.disabled = false;
            }
        }


        // 显示提示信息
        function showMessage(message, type = 'error') {
            messageBox.textContent = message;
            messageBox.className = `text-center p-3 rounded-lg mb-4 ${type === 'error' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`;
            messageBox.classList.remove('hidden');
        }

        function hideMessage() {
            messageBox.classList.add('hidden');
        }

        // 转换按钮点击事件
        convertButton.addEventListener('click', async () => {
            hideMessage();
            setLoading(true);
            resultArea.style.display = 'none';

            const url = urlInput.value.trim();
            if (!url) {
                showMessage('请输入 URL');
                setLoading(false);
                return;
            }

            // 简单的URL验证和补充
            let processedUrl = url.replace(/[;,]+$/, '').trim(); // 移除末尾分号或逗号
            if (!processedUrl.startsWith('http://') && !processedUrl.startsWith('https://')) {
                processedUrl = 'https://' + processedUrl;
            }

            try {
                const response = await fetch('/api', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ url: processedUrl }),
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: '转换失败' }));
                    throw new Error(errorData.error || '转换失败');
                }

                const data = await response.json();

                // 显示预览
                markdownOutput.value = data.markdown;
                articleTitle = data.title.replace(/[^a-z0-9\u4e00-\u9fa5]/gi, '_') || 'article';
                resultArea.style.display = 'block';
                showMessage('转换成功', 'success');

            } catch (error) {
                console.error('Fetch 错误:', error);
                showMessage(error.message);
            } finally {
                setLoading(false);
            }
        });


        // 复制按钮
        copyButton.addEventListener('click', () => {
            try {
                markdownOutput.select();
                document.execCommand('copy');
                copyButton.textContent = '已复制!';
                setTimeout(() => {
                    copyButton.textContent = '复制';
                }, 2000);
            } catch (err) {
                console.error('复制失败:', err);
                alert('复制失败，请手动复制');
            }
        });

        // 单个下载按钮
        downloadButton.addEventListener('click', () => {
            const markdownContent = markdownOutput.value;
            const blob = new Blob([markdownContent], { type: 'text/markdown;charset=utf-8' });
            
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `${articleTitle}.md`;
            
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            URL.revokeObjectURL(a.href);
        });

    </script>
</body>
</html>

